<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - RosaIQ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
    }

    .admin-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-header h1 {
      font-size: 24px;
    }

    .logout-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .admin-container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #ddd;
    }

    .tab {
      padding: 15px 30px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      margin-bottom: 20px;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 5px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .upload-section {
      border: 2px dashed #ddd;
      padding: 30px;
      text-align: center;
      border-radius: 10px;
      background: #fafafa;
    }

    .upload-section input[type="file"] {
      margin: 15px 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
      background: white;
      margin: 5% auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-online {
      background: #d4edda;
      color: #155724;
    }

    .badge-offline {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-admin {
      background: #cce5ff;
      color: #004085;
    }

    .badge-user {
      background: #e2e3e5;
      color: #383d41;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
  </style>
</head>
<body>
  <div class="admin-header">
    <h1>üéõÔ∏è RosaIQ Admin Panel</h1>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="admin-container">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('devices')">All Devices</button>
      <button class="tab" onclick="switchTab('users')">Users</button>
      <button class="tab" onclick="switchTab('firmware')">Firmware</button>
      <button class="tab" onclick="switchTab('assignments')">Device Assignments</button>
    </div>

    <!-- All Devices Tab -->
    <div id="devicesTab" class="tab-content active">
      <div class="card">
        <h2>All Devices</h2>
        <table id="devicesTable">
          <thead>
            <tr>
              <th>Serial Number</th>
              <th>Custom Name</th>
              <th>Assigned To</th>
              <th>Status</th>
              <th>Last Seen</th>
              <th>Firmware</th>
            </tr>
          </thead>
          <tbody id="devicesTableBody">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="usersTab" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>Users</h2>
          <button class="btn btn-success" onclick="openCreateUserModal()">+ Create User</button>
        </div>
        <table id="usersTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
              <th>Created</th>
              <th>Last Login</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Firmware Tab -->
    <div id="firmwareTab" class="tab-content">
      <div class="card">
        <h2>Upload New Firmware</h2>
        <div class="upload-section">
          <h3>üì¶ Upload .bin File</h3>
          <p style="color: #666; margin: 10px 0;">Upload firmware for OTA updates</p>
          <form id="firmwareUploadForm">
            <div class="form-group" style="text-align: left; max-width: 400px; margin: 20px auto;">
              <label>Firmware Version *</label>
              <input type="text" id="firmwareVersion" placeholder="e.g., 1.0.0" required>
            </div>
            <div class="form-group" style="text-align: left; max-width: 400px; margin: 20px auto;">
              <label>Release Notes (optional)</label>
              <input type="text" id="firmwareNotes" placeholder="e.g., Bug fixes and improvements">
            </div>
            <input type="file" id="firmwareFile" accept=".bin" required>
            <br><br>
            <button type="submit" class="btn btn-primary">Upload Firmware</button>
          </form>
        </div>
      </div>

      <div class="card">
        <h2>Uploaded Firmware</h2>
        <table id="firmwareTable">
          <thead>
            <tr>
              <th>Version</th>
              <th>Filename</th>
              <th>Size</th>
              <th>Uploaded By</th>
              <th>Upload Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="firmwareTableBody">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Device Assignments Tab -->
    <div id="assignmentsTab" class="tab-content">
      <div class="card">
        <h2>Unassigned Devices</h2>
        <table id="unassignedTable">
          <thead>
            <tr>
              <th>Serial Number</th>
              <th>First Seen</th>
              <th>Last Seen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="unassignedTableBody">
            <tr><td colspan="4" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Create User Modal -->
  <div id="createUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New User</h2>
      </div>
      <form id="createUserForm">
        <div class="form-group">
          <label>Username *</label>
          <input type="text" id="newUsername" required>
        </div>
        <div class="form-group">
          <label>Password *</label>
          <input type="password" id="newPassword" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="newEmail">
        </div>
        <div class="form-group">
          <label>Role *</label>
          <select id="newRole">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn" onclick="closeCreateUserModal()">Cancel</button>
          <button type="submit" class="btn btn-success">Create User</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Assign Device Modal -->
  <div id="assignDeviceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Assign Device</h2>
      </div>
      <form id="assignDeviceForm">
        <div class="form-group">
          <label>Select User *</label>
          <select id="assignUserId" required>
            <option value="">-- Select User --</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn" onclick="closeAssignDeviceModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Assign</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentAssignDevice = null;
    let allUsers = [];

    // Check authentication
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/session', { credentials: 'include' });
        const data = await response.json();
        
        if (!data.authenticated || data.user.role !== 'admin') {
          window.location.href = '/login.html';
          return;
        }

        currentUser = data.user;
        loadAllData();
      } catch (error) {
        window.location.href = '/login.html';
      }
    }

    async function logout() {
      try {
        await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout failed:', error);
      }
    }

    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');

      // Load data for specific tab
      if (tabName === 'devices') loadDevices();
      else if (tabName === 'users') loadUsers();
      else if (tabName === 'firmware') loadFirmware();
      else if (tabName === 'assignments') loadUnassignedDevices();
    }

    async function loadAllData() {
      await Promise.all([loadDevices(), loadUsers(), loadFirmware(), loadUnassignedDevices()]);
    }

    async function loadDevices() {
      try {
        const response = await fetch('/api/devices', { credentials: 'include' });
        const devices = await response.json();

        const tbody = document.getElementById('devicesTableBody');
        
        if (devices.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No devices found</td></tr>';
          return;
        }

        tbody.innerHTML = devices.map(device => {
          const isOnline = isDeviceActive(device.last_seen);
          const assignedTo = device.user_id ? 'User ID: ' + device.user_id : 'Unassigned';
          const displayName = device.custom_name || '-';
          
          return `
            <tr>
              <td>${device.serial_number}</td>
              <td>${displayName}</td>
              <td>${assignedTo}</td>
              <td><span class="badge ${isOnline ? 'badge-online' : 'badge-offline'}">${isOnline ? 'Online' : 'Offline'}</span></td>
              <td>${new Date(device.last_seen).toLocaleString()}</td>
              <td>${device.firmware_version || '-'}</td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load devices:', error);
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch('/api/users', { credentials: 'include' });
        allUsers = await response.json();

        const tbody = document.getElementById('usersTableBody');
        
        if (allUsers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>';
          return;
        }

        tbody.innerHTML = allUsers.map(user => `
          <tr>
            <td>${user.username}</td>
            <td>${user.email || '-'}</td>
            <td><span class="badge ${user.role === 'admin' ? 'badge-admin' : 'badge-user'}">${user.role}</span></td>
            <td>${new Date(user.created_at).toLocaleDateString()}</td>
            <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
            <td>
              ${user.username !== 'admin' ? `<button class="btn btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">Delete</button>` : '-'}
            </td>
          </tr>
        `).join('');

        // Update assign device dropdown
        updateUserDropdown();
      } catch (error) {
        console.error('Failed to load users:', error);
      }
    }

    async function loadFirmware() {
      try {
        const response = await fetch('/api/admin/firmware', { credentials: 'include' });
        const firmware = await response.json();

        const tbody = document.getElementById('firmwareTableBody');
        
        if (firmware.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No firmware uploaded</td></tr>';
          return;
        }

        tbody.innerHTML = firmware.map((fw, index) => `
          <tr>
            <td><strong>${fw.version}</strong> ${index === 0 ? '(Latest)' : ''}</td>
            <td>${fw.filename}</td>
            <td>${(fw.file_size / 1024 / 1024).toFixed(2)} MB</td>
            <td>User ID: ${fw.uploaded_by}</td>
            <td>${new Date(fw.uploaded_at).toLocaleString()}</td>
            <td>
              <button class="btn btn-danger" onclick="deleteFirmware(${fw.id}, '${fw.version}')">Delete</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load firmware:', error);
      }
    }

    async function loadUnassignedDevices() {
      try {
        const response = await fetch('/api/admin/devices/unassigned', { credentials: 'include' });
        const devices = await response.json();

        const tbody = document.getElementById('unassignedTableBody');
        
        if (devices.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="empty-state">All devices are assigned</td></tr>';
          return;
        }

        tbody.innerHTML = devices.map(device => `
          <tr>
            <td>${device.serial_number}</td>
            <td>${new Date(device.first_seen).toLocaleString()}</td>
            <td>${new Date(device.last_seen).toLocaleString()}</td>
            <td>
              <button class="btn btn-primary" onclick="openAssignDeviceModal('${device.device_id}')">Assign to User</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load unassigned devices:', error);
      }
    }

    function isDeviceActive(lastSeen) {
      const diff = Date.now() - new Date(lastSeen).getTime();
      return diff < 10 * 60 * 1000; // Active if seen in last 10 minutes
    }

    // User Management
    function openCreateUserModal() {
      document.getElementById('createUserModal').style.display = 'block';
    }

    function closeCreateUserModal() {
      document.getElementById('createUserModal').style.display = 'none';
      document.getElementById('createUserForm').reset();
    }

    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('newUsername').value;
      const password = document.getElementById('newPassword').value;
      const email = document.getElementById('newEmail').value;
      const role = document.getElementById('newRole').value;

      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password, email, role })
        });

        if (response.ok) {
          alert('User created successfully!');
          closeCreateUserModal();
          loadUsers();
        } else {
          const error = await response.json();
          alert('Failed to create user: ' + error.error);
        }
      } catch (error) {
        alert('Failed to create user');
      }
    });

    async function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to delete user "${username}"?`)) return;

      try {
        const response = await fetch(`/api/users/${userId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          alert('User deleted successfully');
          loadUsers();
        } else {
          alert('Failed to delete user');
        }
      } catch (error) {
        alert('Failed to delete user');
      }
    }

    // Device Assignment
    function updateUserDropdown() {
      const select = document.getElementById('assignUserId');
      select.innerHTML = '<option value="">-- Select User --</option>' +
        allUsers.filter(u => u.role === 'user').map(u => 
          `<option value="${u.id}">${u.username}</option>`
        ).join('');
    }

    function openAssignDeviceModal(deviceId) {
      currentAssignDevice = deviceId;
      document.getElementById('assignDeviceModal').style.display = 'block';
    }

    function closeAssignDeviceModal() {
      document.getElementById('assignDeviceModal').style.display = 'none';
      currentAssignDevice = null;
    }

    document.getElementById('assignDeviceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const userId = document.getElementById('assignUserId').value;

      try {
        const response = await fetch(`/api/devices/${currentAssignDevice}/assign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ userId })
        });

        if (response.ok) {
          alert('Device assigned successfully!');
          closeAssignDeviceModal();
          loadUnassignedDevices();
          loadDevices();
        } else {
          alert('Failed to assign device');
        }
      } catch (error) {
        alert('Failed to assign device');
      }
    });

    // Firmware Upload
    document.getElementById('firmwareUploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const version = document.getElementById('firmwareVersion').value;
      const notes = document.getElementById('firmwareNotes').value;
      const file = document.getElementById('firmwareFile').files[0];

      if (!file) {
        alert('Please select a firmware file');
        return;
      }

      const formData = new FormData();
      formData.append('firmware', file);
      formData.append('version', version);
      formData.append('notes', notes);

      try {
        const response = await fetch('/api/admin/firmware/upload', {
          method: 'POST',
          credentials: 'include',
          body: formData
        });

        if (response.ok) {
          alert('Firmware uploaded successfully!');
          document.getElementById('firmwareUploadForm').reset();
          loadFirmware();
        } else {
          const error = await response.json();
          alert('Failed to upload firmware: ' + error.error);
        }
      } catch (error) {
        alert('Failed to upload firmware');
      }
    });

    async function deleteFirmware(id, version) {
      if (!confirm(`Are you sure you want to delete firmware version ${version}?`)) return;

      try {
        const response = await fetch(`/api/admin/firmware/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (response.ok) {
          alert('Firmware deleted successfully');
          loadFirmware();
        } else {
          alert('Failed to delete firmware');
        }
      } catch (error) {
        alert('Failed to delete firmware');
      }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }

    // Initialize
    checkAuth();
  </script>
</body>
</html>
